# 北马AI工具包 - 打包部署指南

**北马AI·与你同在 😊**

## 📌 快速导航

- [打包前准备](#打包前准备)
- [Windows 打包](#windows-打包)
- [macOS 打包](#macos-打包)
- [Linux 打包](#linux-打包)
- [常见问题](#常见问题)
- [发布流程](#发布流程)

---

## 🎯 打包概述

### 什么是打包?

将前端代码(React)和后端代码(Rust)编译、优化、打包成可执行的桌面应用,生成平台特定的安装包:

| 平台 | 输出格式 | 文件名示例 |
|------|---------|----------|
| Windows | MSI 安装包 | `BMAI-Tools_v3.8.0_x64_en-US.msi` |
| Windows | 便携版 | `BMAI-Tools-v3.8.0-Portable.zip` |
| Windows | 可执行程序 | `BMAI-Tools.exe` |
| macOS | DMG 磁盘镜像 | `BMAI-Tools_v3.8.0_x64.dmg` |
| macOS | APP 包 | `BMAI-Tools.app` |
| Linux | AppImage | `BMAI-Tools_v3.8.0_x64.AppImage` |
| Linux | DEB 包 | `bmai-tools_v3.8.0_amd64.deb` |

### 打包输出位置

```
src-tauri/target/release/bundle/
├── msi/              # Windows MSI 安装包
│   ├── BMAI-Tools_v3.8.0_x64_en-US.msi
│   ├── BMAI-Tools_v3.8.0_x64_zh-CN.msi
│   └── BMAI-Tools_v3.8.0_x64_ja-JP.msi
├── nsis/             # Windows NSIS 可执行安装程序
│   └── BMAI-Tools_v3.8.0_x64-setup.exe
├── macos/            # macOS 应用包和磁盘镜像
│   ├── BMAI-Tools.app
│   └── BMAI-Tools_v3.8.0_x64.dmg
├── appimage/         # Linux AppImage
│   └── BMAI-Tools_v3.8.0_x64.AppImage
├── deb/              # Linux DEB 包
│   └── bmai-tools_v3.8.0_amd64.deb
└── portable/         # Windows 便携版(无安装)
    └── BMAI-Tools-v3.8.0-Portable.zip
```

---

## 🛠️ 打包前准备

### 环境检查

```bash
# 检查 Node.js
node --version  # 应该 >= 20.x

# 检查 pnpm
pnpm --version  # 应该 >= 10.x

# 检查 Rust
rustc --version  # 应该 >= 1.85.0
cargo --version

# 检查 Tauri CLI
tauri --version  # 应该是 2.x
```

### 更新依赖

```bash
cd D:\xiaobei_Work\GitHub\bmai-tools

# 更新前端依赖
pnpm install
pnpm typecheck  # 确保没有类型错误

# 更新后端依赖
cd src-tauri
cargo update
cd ..
```

### 版本号更新

编辑 `src-tauri/Cargo.toml` 更新版本:

```toml
[package]
name = "bmai-tools"
version = "3.8.0"  # 修改这里
```

同步更新 `package.json`:

```json
{
  "name": "bmai-tools",
  "version": "0.0.1",  # 这个是 npm 包版本,可以不同
  ...
}
```

---

## 🪟 Windows 打包

### 方式一: 完整打包(生成 MSI + 便携版)

#### 步骤 1: 执行打包命令

```bash
cd D:\xiaobei_Work\GitHub\bmai-tools

# 开始打包(首次需要 15-30 分钟)
pnpm tauri build

# 预期输出:
# ✓ Bundling BMAI-Tools-v3.8.0_x64_en-US.msi...
# ✓ Built successfully at:
#   src-tauri/target/release/bundle/msi/BMAI-Tools-v3.8.0_x64_en-US.msi
```

#### 步骤 2: 查找生成的文件

```bash
# MSI 安装包位置
ls src-tauri/target/release/bundle/msi/

# 输出示例:
# BMAI-Tools_v3.8.0_x64_en-US.msi        (50 MB)
# BMAI-Tools_v3.8.0_x64_zh-CN.msi        (50 MB)
# BMAI-Tools_v3.8.0_x64_ja-JP.msi        (50 MB)
```

#### 步骤 3: 测试安装包

```bash
# 双击 MSI 文件进行安装
BAI-Tools_v3.8.0_x64_en-US.msi

# 或使用命令行安装(管理员权限)
msiexec /i "BMAI-Tools_v3.8.0_x64_en-US.msi"

# 静默安装
msiexec /i "BMAI-Tools_v3.8.0_x64_en-US.msi" /quiet
```

### 方式二: 仅生成便携版(ZIP)

便携版不需要安装,直接运行:

```bash
# 生成便携版
cd D:\xiaobei_Work\GitHub\bmai-tools
pnpm tauri build -- --target portable

# 输出位置: src-tauri/target/release/bundle/portable/
```

### 方式三: 仅生成 NSIS 可执行安装程序

```bash
# 生成 .exe 安装程序
pnpm tauri build -- --format nsis

# 输出文件: src-tauri/target/release/bundle/nsis/BMAI-Tools_v3.8.0_x64-setup.exe
```

### 自定义打包配置

编辑 `src-tauri/tauri.conf.json`:

```json
{
  "productName": "BMAI-Tools",
  "version": "3.8.0",
  "identifier": "com.bayma.bmai-tools",
  "build": {
    "devUrl": "http://localhost:5173",
    "frontendDist": "../dist"
  },
  "app": {
    "windows": [
      {
        "title": "北马AI工具包",
        "width": 1200,
        "height": 800,
        "resizable": true,
        "fullscreen": false
      }
    ],
    "security": {
      "csp": "default-src blob: data: filesystem: ws: wss: http: https: tauri: 'unsafe-inline' 'unsafe-eval'; img-src: * data: blob: filesystem:;"
    }
  },
  "bundle": {
    "active": true,
    "targets": ["msi", "nsis"],  # 选择要打包的格式
    "resources": []
  }
}
```

---

## 🍎 macOS 打包

### 前置条件

```bash
# macOS 需要安装以下工具
# Xcode Command Line Tools
xcode-select --install

# 如果已安装,可以跳过
xcode-select -p  # 验证是否已安装
```

### 步骤 1: 执行打包

```bash
cd /Users/username/path/to/bmai-tools

# 打包(首次需要 15-30 分钟)
pnpm tauri build

# 预期输出:
# ✓ Bundling BMAI-Tools_v3.8.0_x64.dmg...
# ✓ Built successfully at:
#   src-tauri/target/release/bundle/macos/BMAI-Tools_v3.8.0_x64.dmg
```

### 步骤 2: 获取输出文件

```bash
# DMG 磁盘镜像
ls -lah src-tauri/target/release/bundle/macos/

# 输出:
# BMAI-Tools.app                    # 应用包
# BMAI-Tools_v3.8.0_x64.dmg        # 磁盘镜像
```

### 步骤 3: 测试 DMG

```bash
# 双击打开 DMG 文件
open src-tauri/target/release/bundle/macos/BMAI-Tools_v3.8.0_x64.dmg

# 或挂载 DMG
hdiutil attach BMAI-Tools_v3.8.0_x64.dmg

# 复制 app 到 Applications
cp -r /Volumes/BMAI-Tools.app /Applications/
```

### 代码签名和公证(可选)

用于 App Store 或官方分发:

```bash
# 使用 Apple 开发者证书签名
codesign --deep --force --verify --verbose --sign - /path/to/BMAI-Tools.app

# 公证应用(提交到 Apple 验证)
xcrun altool --notarize-app -f BMAI-Tools_v3.8.0_x64.dmg -t osx -u apple_id@example.com -p app_password
```

---

## 🐧 Linux 打包

### 前置条件

```bash
# Ubuntu/Debian
sudo apt-get install -y \
  build-essential \
  libssl-dev \
  pkg-config \
  libxdo-dev \
  libssl-dev \
  libappindicator3-dev \
  libwebkit2gtk-4.0-dev \
  curl \
  wget \
  file

# Fedora
sudo dnf install -y \
  gcc \
  openssl-devel \
  pkg-config \
  libxdo-devel \
  webkit2gtk3-devel \
  curl \
  wget
```

### 步骤 1: 执行打包

```bash
cd ~/path/to/bmai-tools

# 打包
pnpm tauri build

# 预期输出:
# ✓ Bundling BMAI-Tools_v3.8.0_x64.AppImage...
# ✓ Bundling bmai-tools_v3.8.0_amd64.deb...
# ✓ Built successfully at:
#   src-tauri/target/release/bundle/appimage/
#   src-tauri/target/release/bundle/deb/
```

### 步骤 2: 获取输出文件

```bash
# AppImage 和 DEB 包
ls -lh src-tauri/target/release/bundle/appimage/
ls -lh src-tauri/target/release/bundle/deb/

# 输出:
# BMAI-Tools_v3.8.0_x64.AppImage        (50 MB)
# bmai-tools_v3.8.0_amd64.deb           (40 MB)
```

### 步骤 3: 测试 AppImage

```bash
# 给 AppImage 添加执行权限
chmod +x BMAI-Tools_v3.8.0_x64.AppImage

# 直接运行
./BMAI-Tools_v3.8.0_x64.AppImage

# 或安装到系统
./BMAI-Tools_v3.8.0_x64.AppImage install
```

### 步骤 4: 测试 DEB 包

```bash
# 安装 DEB 包
sudo dpkg -i bmai-tools_v3.8.0_amd64.deb

# 卸载
sudo dpkg -r bmai-tools

# 使用 apt 安装(如果发布到 apt 源)
sudo apt install ./bmai-tools_v3.8.0_amd64.deb
```

---

## 🐛 常见问题

### Q1: 打包时出现 "yarn not found" 错误

**解决:**
```bash
# 确保使用 pnpm
which pnpm
pnpm install

# 检查 package.json packageManager 字段
"packageManager": "pnpm@10.10.0+..."
```

### Q2: Rust 编译很慢

**原因:** 首次编译需要下载和编译所有依赖

**解决:**
```bash
# 使用 sccache 加速编译
cargo install sccache
export RUSTC_WRAPPER=sccache

# 再次运行打包
pnpm tauri build
```

### Q3: "Cannot find node_modules" 错误

**解决:**
```bash
# 重新安装依赖
rm -rf node_modules pnpm-lock.yaml
pnpm install

# 清理 Rust 缓存
cd src-tauri
cargo clean
cd ..

# 重新打包
pnpm tauri build
```

### Q4: Windows 打包生成的 MSI 很大(100+ MB)

**原因:** 包含了调试符号

**解决:**
```bash
# 编辑 src-tauri/Cargo.toml
[profile.release]
strip = "symbols"  # 去掉调试符号
lto = "thin"       # 启用 LTO 优化
```

### Q5: macOS 打开 DMG 时出现"损坏的应用"提示

**解决:**
```bash
# 移除 macOS 隔离标记
xattr -rd com.apple.quarantine /path/to/BMAI-Tools.app

# 或信任应用
sudo spctl --add /Applications/BMAI-Tools.app
```

### Q6: Linux AppImage 无法运行

**解决:**
```bash
# 确保有执行权限
chmod +x BMAI-Tools_v3.8.0_x64.AppImage

# 检查依赖
ldd BMAI-Tools_v3.8.0_x64.AppImage

# 使用 FUSE 支持
sudo apt install libfuse2  # Ubuntu/Debian
```

---

## 📤 发布流程

### GitHub Releases 发布

#### 步骤 1: 创建发布标签

```bash
cd D:\xiaobei_Work\GitHub\bmai-tools

# 创建 git 标签
git tag -a v3.8.0 -m "Release version 3.8.0"

# 推送标签到远程
git push origin v3.8.0
```

#### 步骤 2: 创建 GitHub Release

```bash
# 使用 gh 命令行工具
gh release create v3.8.0 \
  --title "BMAI Tools v3.8.0" \
  --notes "Major features and improvements" \
  src-tauri/target/release/bundle/msi/*.msi \
  src-tauri/target/release/bundle/macos/*.dmg \
  src-tauri/target/release/bundle/appimage/*.AppImage \
  src-tauri/target/release/bundle/deb/*.deb
```

#### 步骤 3: 编写发布说明

在 GitHub 网页界面编写发布说明 Markdown:

```markdown
## 北马AI工具包 v3.8.0

🎉 新版本发布!

### 新增功能
- ✨ 持久化架构升级 - SQLite + JSON 双层存储
- 🎨 全新 UI 设计 - 布局重构,统一组件样式
- 🇯🇵 日语支持 - 新增日语界面

### 改进
- 🚀 性能优化
- 🐛 Bug 修复
- 📚 文档完善

### 下载
- Windows: `BMAI-Tools_v3.8.0_x64_en-US.msi`
- macOS: `BMAI-Tools_v3.8.0_x64.dmg`
- Linux: `BMAI-Tools_v3.8.0_x64.AppImage`

### 感谢
感谢所有贡献者和用户的支持!
```

### 自动更新

Tauri 内置自动更新功能:

```json
{
  "updater": {
    "active": true,
    "dialog": true,
    "endpoints": [
      "https://releases.example.com/updates/{{target}}/{{arch}}/{{current_version}}"
    ],
    "windows": {
      "installMode": "passive"
    }
  }
}
```

用户启动应用时自动检查更新。

---

## 📋 打包检查清单

发布前检查:

- [ ] 更新版本号(Cargo.toml, package.json)
- [ ] 运行 `pnpm typecheck` 确保没有类型错误
- [ ] 运行 `cargo test` 确保后端测试通过
- [ ] 运行 `pnpm test:unit` 确保前端测试通过
- [ ] 更新 CHANGELOG.md
- [ ] 测试所有平台的安装包
- [ ] 验证应用功能正常
- [ ] 创建 git 标签
- [ ] 发布到 GitHub Releases
- [ ] 更新文档

---

## 📚 快速命令参考

```bash
# 完整打包(所有平台)
pnpm tauri build

# 仅打包 Windows MSI
pnpm tauri build -- --target msi

# 仅打包 Windows 便携版
pnpm tauri build -- --target portable

# 仅打包 macOS DMG
pnpm tauri build -- --target dmg

# 仅打包 Linux AppImage
pnpm tauri build -- --target appimage

# 仅打包 Linux DEB
pnpm tauri build -- --target deb

# 打包前清理
cd src-tauri && cargo clean && cd ..
pnpm tauri build

# 生成发布说明
gh release notes v3.8.0 > release-notes.md
```

---

<div align="center">

**🐴 北马AI·与你同在 😊**

Happy packaging! 🚀

[返回README](../README.md) | [开发指南](./开发步骤操作文档.md) | [架构文档](./项目架构文档.md)

</div>
